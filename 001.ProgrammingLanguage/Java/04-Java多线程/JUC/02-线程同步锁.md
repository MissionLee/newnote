# çº¿ç¨‹åŒæ­¥é”

å‚è€ƒï¼šhttps://blog.csdn.net/androidsj/article/details/80239640 

> JUCé”æœºåˆ¶

- æ ¸å¿ƒæ¥å£: Lock,ReadWriteLock;
- AQSæŠ½è±¡ç±»ï¼ˆåŒæ­¥å™¨ï¼‰
  - AbstractOwnableSynchronizer
    - å¯ç”±çº¿ç¨‹ä¸“æœ‰çš„åŒæ­¥å™¨
  - AbstractQueuedLongSychronizer
    - 64ä½æ¸…ç©ºçš„AbstractQueueSynchronizer
  - AbstractQueueSynchronizer
    - æä¾›ä¸€ä¸ªæ¡†æ¶ï¼Œç”¨äºå®ç°ä¾èµ–äºå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ç­‰å¾…é˜Ÿåˆ—çš„é˜»å¡é”å’Œç›¸å…³åŒæ­¥å™¨ï¼ˆä¿¡å·é‡ï¼Œäº‹ä»¶ç­‰ï¼‰
- å·¥å…·ç±»/æ¥å£
  - Lock é”æ¥å£
    - å®ç°ç±»ï¼šReentrantLock äº’æ–¥é”  
  - LockSupprot ç±»ï¼Œé˜»å¡åŸè¯­
    - ä¸ºåˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çš„çº¿ç¨‹é˜»å¡æœºåˆ¶
  - ReadWriteLock è¯»å†™é”æ¥å£
    - å®ç°ç±» ReentrantReadWriteLock
  - StampedLock ğŸ”º
  - Condition é˜Ÿåˆ—æ§åˆ¶
  - Semaphore ä¿¡å·é‡
  - CountDownLatché—­é”
  - CyclicBarrieræ …æ 
  - Exchangeräº¤æ¢æœº
  - CompletableFutureçº¿ç¨‹å›è°ƒ
  - ğŸ”º ç­‰ç­‰

## java.util.concurrenté”æ¦‚è§ˆ

- java.util.concurrent.lockæä¾›é”çš„åŸºç¡€æ”¯æŒ
- Lockæ¥å£ï¼šæ”¯æŒäºä¸€ä¸åŒï¼ˆå†²å…¥ï¼Œå…¬å¹³ï¼‰çš„é”è§„åˆ™
  - æ‰€è°“è¯­ä¹‰ä¸åŒï¼Œæ˜¯æŒ‡é”å¯æ˜¯æœ‰â€å…¬å¹³æœºåˆ¶çš„é”â€ã€â€éå…¬å¹³æœºåˆ¶çš„é”â€ã€â€å¯é‡å…¥çš„é”â€ç­‰ç­‰ï¼›
    - â€œå…¬å¹³æœºåˆ¶â€ :æŒ‡ â€œä¸åŒçº¿ç¨‹è·å–é”çš„æœºåˆ¶æ˜¯å…¬å¹³çš„â€ ;
    -  â€œéå…¬å¹³æœºåˆ¶â€ : æŒ‡ â€œä¸åŒçº¿ç¨‹è·å–é”çš„æœºåˆ¶æ˜¯éå…¬å¹³çš„â€ ;
    - â€œå¯é‡å…¥çš„é”â€ : æŒ‡ åŒä¸€ä¸ªé”èƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ï¼Œå¯é‡å…¥é”æœ€å¤§çš„ä½œç”¨æ˜¯é¿å…æ­»é”ã€‚
- ReadWriteLockæ¥å£å’ŒLockç±»ä¼¼çš„æ–¹å¼å®šä¹‰äº†
  - â­â­ è¯»å–è€…å¯ä»¥å…±äº«ï¼Œè€Œå†™å…¥ç‹¬å çš„é”
- Conditionæ¥å£ï¼š æ¥å£æè¿°äº†å¯èƒ½ä¼šä¸é”æœ‰å…³è”çš„æ¡ä»¶å˜é‡ï¼ˆObjectç±»ä¸­çš„wait()æ–¹æ³•ä½¿ç”¨ç±»ä¼¼ï¼‰

### å…¬å¹³é”çš„æ ¸å¿ƒæ¦‚å¿µ
- public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable
  - è¿™ä¸¤ä¸ªä¸»è¦abstractç±»ç”±ç»§æ‰¿å…³ç³»
  - AbstractownableSynchronizer åªæ˜¯ç®€å•è§„å®šäº†ä¸Threadçš„ç»‘å®šå…³ç³»
- AbstractQueuedSynchronizerï¼šæ˜¯javaä¸­ç®¡ç†â€œ é”â€çš„æŠ½è±¡ç±»ï¼Œé”çš„è®¸å¤šå…¬å…±æ–¹æ³•éƒ½æ˜¯åœ¨è¿™ä¸ªç±»ä¸­å®ç°ã€‚AbstractQueuedSynchronizeræ˜¯ç‹¬å é”ï¼ˆä¾‹å¦‚ï¼ŒReentrantLockï¼‰
- AbstractQueuedSynchronizerç±»åˆ«ï¼š
  - ç‹¬å é”ï¼šé”åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹é”å æœ‰ï¼Œæ ¹æ®é”çš„è·å–æœºåˆ¶ï¼Œå®ƒåˆåˆ’åˆ†ä¸ºâ€œå…¬å¹³é”â€å’Œâ€œéå…¬å¹³é”â€ã€‚
    - å…¬å¹³é”ï¼Œæ˜¯æŒ‰ç…§é€šè¿‡CLHç­‰å¾…çº¿ç¨‹æŒ‰ç…§å…ˆæ¥å…ˆå¾—çš„è§„åˆ™ï¼Œå…¬å¹³çš„è·å–é”
    - éå…¬å¹³é”ï¼Œåˆ™å½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œå®ƒä¼šæ— è§†CLHç­‰å¾…é˜Ÿåˆ—è€Œç›´æ¥è·å–é”ã€‚
  - å…±äº«é”ï¼šèƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‹¥æœ‰ï¼Œèƒ½è¢«å…±äº«çš„é”ï¼›
- CLHé˜Ÿåˆ—ï¼ˆCraig,Landin,and Hagersten locksï¼‰ï¼š
  - CLHé”ä¹Ÿæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹åªåœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è®­å‰é©±çš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸå­æ—‹ã€‚
- CASæ–¹æ³•ï¼ˆCompare And Swapï¼‰ï¼šæ¯”è¾ƒå¹¶äº¤æ¢æ–¹æ³•ï¼Œå®ƒæ˜¯åŸå­æ“ä½œæ–¹æ³•ï¼›å³ï¼Œé€šè¿‡CASæ“ä½œçš„æ•°æ®éƒ½æ˜¯ä»¥åŸå­æ–¹å¼è¿›è¡Œçš„ã€‚

> CLHé” è§£å†³æ­»é”é—®é¢˜

![](./res/001.png)

> AbstractQueuedSynchronizer åˆ†æ

- æºç ä¸­çš„æ³¨é‡Šæ€»ç»“ï¼š
  - AbstractQueuedSynchronizerä¸º blocking locks è¿˜æœ‰ç±»ä¼¼çš„ synchronizersæä¾›äº†åŸºç¡€æ¡†æ¶ï¼Œå®ç°FIFOç­‰å¾…é˜Ÿåˆ—ã€‚
  - è¿™ä¸ªç±»ä¸ºåŒç±»å‹çš„synchronizeræä¾›äº†åŸºç¡€åŠŸèƒ½ï¼šç”¨ä¸€ä¸ª atomic int value æ¥ä»£è¡¨stateï¼Œå­ç±»å¿…é¡»å®šä¹‰protected methodæ¥æ”¹å˜çŠ¶æ€ï¼Œå¹¶ä¸”å®šä¹‰é‚£ç§çŠ¶æ€ä»£è¡¨acquired / released
  - é‰´äºä¸Šé¢çš„å†…å®¹ï¼Œç±»ä¸­å…¶ä»–æ–¹æ³•æä¾›äº†å®Œæ•´çš„ é˜Ÿåˆ—ä¸é˜»å¡ æœºåˆ¶ã€‚
  - å­ç±»å¯ä»¥ç»´æŠ¤å…¶ä»–çŠ¶æ€å­—æ®µï¼Œä½†æ˜¯ä»…æœ‰æ–¹æ³• getState / setState / compareAndSetStateæ“ä½œ è·Ÿè¸ªåŒæ­¥
  - Subclasses 

[AbstractQueuedSynchronizerè¯¦è§£â­â­å¾ˆé‡è¦](./11-Lockè§£æä¸AbstractQueuedSynchronizerä½¿ç”¨.md)

### ã€ ç‹¬å é”ï¼šReentrantLock ã€‘
- ReentrantLockæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é”ï¼Œåˆè¢«ç§°ä¸ºâ€ç‹¬å é”â€ã€‚
- ReentrantLocké”åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹é”æŒæœ‰ï¼›è€Œå¯é‡å…¥çš„æ„æ€æ˜¯ï¼Œ  ReentrantLocké”ï¼Œå¯ä»¥è¢«å•ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ã€‚
- ReentrantLockåˆ†ä¸ºâ€å…¬å¹³é”â€å’Œâ€œéå…¬å¹³é”â€ã€‚å®ƒä»¬çš„åŒºåˆ«ä½“ç°åœ¨è·å–é”çš„æœºåˆ¶ä¸Šæ˜¯å¦å…¬å¹³ä»¥åŠæ‰§è¡Œé€Ÿåº¦ä¸Šã€‚
- ReentrantLockæ˜¯é€šè¿‡ä¸€ä¸ªFIFOçš„ç­‰å¾…é˜Ÿåˆ—æ¥ç®¡ç†è·å–è¯¥é”æ‰€æœ‰çº¿ç¨‹çš„ã€‚   

ReentrantLockæ˜¯ä¸€ä¸ªç‹¬å é”ï¼Œåœ¨è·å–é”çš„ä¹‹åå…¶æ‰€æœ‰çš„æ“ä½œæ˜¯çº¿ç¨‹ç‹¬äº«çš„ï¼Œå…¶å®ƒçš„çº¿ç¨‹åœ¨æ²¡æœ‰è·å–åˆ°é”ä¹‹å‰éƒ½éœ€è¦è¿›è¡Œç­‰å¾…ã€‚
```java
public class ReentrantLockclass Objectimplements Lock, Serializable   
```
ReentrantLockä¹‹ä¸­åˆ†ä¸ºå…¬å¹³é”ä¸éå…¬å¹³é”ï¼Œè€Œè¿™ä¸¤ç§é”çš„å¯ç”¨ä¹Ÿæ˜¯éå¸¸å®¹æ˜“æ§åˆ¶çš„ï¼Œå› ä¸ºåœ¨è¿™ä¸ªç±»ä¸Šæä¾›çš„æ„é€ æ–¹æ³•ï¼š    
- æ— å‚æ„é€ ï¼ˆéå…¬å¹³é”, NonfairSyncï¼‰ï¼špublic ReentrantLock();    
- æœ‰å‚æ„é€ ï¼špublic ReentrantLock(Boolean fair); 
  - fair = true; è¡¨ç¤ºå…¬å¹³é”, FairSync ; 
  - fair = false; è¡¨ç¤ºéå…¬å¹³é”,NonfairSync ; 

èŒƒä¾‹ï¼šå®šä¹‰ä¸ªå¤šçº¿ç¨‹å–ç¥¨çš„å¤„ç†ç¨‹åº
```java

import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
public class MLDNTestDemo {
    public static void main(String[] args) throws Exception {
        Ticket ticket = new Ticket() ; // å¤šä¸ªçº¿ç¨‹è¦å…±äº«åŒä¸€ä¸ªæ•°æ®èµ„æº
        for (int x = 0 ; x < 6 ; x ++) {
            new Thread(() -> {
                while (true) {
                    ticket.sale();     // å–ç¥¨å¤„ç†
                }
            }).start();
        }
    }
}
class Ticket {
    private Lock myLock = new ReentrantLock();
    private int count = 100; // ä¸€å…±10å¼ ç¥¨
    public void sale() { // è¿›è¡Œå–ç¥¨å¤„ç†
        myLock.lock(); // è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œä¸€ç›´åˆ°unlockæ‰§è¡Œåè§£é™¤é˜»å¡
        try {
            if (this.count > 0) {
                System.out.println(
                        Thread.currentThread().getName()
                        + "å–ç¥¨ï¼Œticket = " + this.count --);
            }
        } finally {
            myLock.unlock();   // ä¸ç®¡æœ€ç»ˆå¦‚ä½•ç»“æœä¸€å®šè¦è¿›è¡Œè§£é”
        }
    }
}
```
å½“å‰çš„ä»£ç è¦æ¯”ç›´æ¥ä½¿ç”¨synchronizedæ›´åŠ å®¹æ˜“ï¼Œè€Œä¸”é”çš„å¤„ç†æœºåˆ¶æ›´åŠ ç›´è§‚ï¼Œé€šè¿‡æºä»£ç å¯å‘ç°ï¼Œä½¿ç”¨lock()è¿›è¡Œé”å®šçš„æ—¶å€™ä¼šè€ƒè™‘ä¸¤ç§æƒ…å†µï¼š
![](./res/002.png)

åœ¨è¿›è¡Œå…¬å¹³é”å¤„ç†çš„æ—¶å€™æ¯å½“é”å®šä¸€ä¸ªçº¿ç¨‹å¯¹è±¡å°±ä¼šä½¿ç”¨â€acquire(1)â€æ–¹æ³•è¿›è¡Œè¡¨ç¤ºï¼Œåœ¨è¿›è¡Œè§£é”çš„æ—¶å€™ä¼šä½¿ç”¨ä¸€ä¸ªâ€sync.release(1)â€é‡Šæ”¾æ–¹æ³•ï¼Œ1è¡¨ç¤ºé‡Šæ”¾ä¸€ä¸ªã€‚

## ã€ è¯»å†™é”ï¼šReadWriteLock ã€‘

æ‰€è°“çš„è¯»å†™é”æŒ‡çš„æ˜¯æœ‰ä¸¤æŠŠé”ï¼Œåœ¨è¿›è¡Œæ•°æ®å†™å…¥çš„æ—¶å€™æœ‰ä¸€æŠŠâ€å†™é”â€ï¼Œè€Œåœ¨è¿›è¡Œæ•°æ®è¯»å–çš„æ—¶å€™æœ‰ä¸€æŠŠâ€è¯»é”â€ï¼Œå¾ˆæ˜æ˜¾å†™é”ä¸€å®šä¼šå®ç°çº¿ç¨‹å®‰å…¨åŒæ­¥å¤„ç†æ“ä½œï¼Œè€Œè¯»é”å¯ä»¥è¢«å¤šä¸ªå¯¹è±¡è¯»å–è·å¾—ã€‚

- åˆ†ä¸ºè¯»é”å’Œå†™é”ï¼Œå¤šä¸ªè¯»é”ä¸äº’æ–¥ï¼ˆå…±äº«é”ï¼‰ï¼Œè¯»é”ä¸å†™é”äº’æ–¥ï¼Œè¿™æ˜¯ç”±jvmè‡ªå·±æ§åˆ¶çš„ï¼Œå¼€å‘è€…åªè¦ä¸Šå¥½ç›¸åº”çš„é”å³å¯ï¼›
- ReentrantReadWriteLockä¼šä½¿ç”¨ä¸¤æŠŠé”æ¥è§£å†³é—®é¢˜ï¼Œä¸€ä¸ªè¯»é”ï¼ˆå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼‰ï¼Œä¸€ä¸ªå†™é”ï¼ˆå•ä¸ªçº¿ç¨‹å†™ï¼‰ã€‚
- ReadLockå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰å¹¶ä¸”åœ¨ä½œç”¨æ—¶æ’æ–¥ä»»ä½•çš„WriteLockï¼Œè€ŒWriteLockåˆ™æ˜¯å®Œå…¨çš„äº’æ–¥ï¼Œè¿™ä¸€ç‰¹æ€§æœ€ä¸ºé‡è¦ï¼Œå› ä¸ºå¯¹ äºé«˜è¯»å–é¢‘ç‡è€Œç›¸å¯¹è¾ƒä½å†™å…¥çš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨æ­¤ç±»é”åŒæ­¥æœºåˆ¶åˆ™å¯ä»¥æé«˜å¹¶å‘é‡ï¼›

ä¸‹é¢ç¼–å†™ä¸€ä¸ªé“¶è¡Œå­˜æ¬¾ç¨‹åºï¼Œç°åœ¨æœ‰10ä¸ªäººå‘ä½ çš„é“¶è¡Œè´¦æˆ·å­˜æ¬¾ï¼Œå­˜æ”¾çš„ä¸€å®šè¦é‡‡ç”¨ç‹¬å é”(å†™é”),è€Œåœ¨è¯»å–çš„æ—¶å€™æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¯ä»¥è¯»å–ï¼Œåº”è¯¥ä½¿ç”¨å…±äº«é”(è¯»é”)ã€‚

åœ¨ReadWriteLockæ¥å£é‡Œé¢å¯ä»¥å‘ç°æœ‰å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è·å¾—é”ï¼š
  - è·å¾—å†™é”ï¼špublic Lock writeLock();
  - è·å¾—è¯»é”ï¼špublic Lock readLock();
  
èŒƒä¾‹ï¼šå®ç°è¯»å†™é”çš„å¤„ç†æ“ä½œ
```java

import java.util.concurrent.TimeUnit;

import java.util.concurrent.locks.ReadWriteLock;

import java.util.concurrent.locks.ReentrantReadWriteLock;

 

public class MLDNTestDemo {
    public static void main(String[] args) throws Exception {
        Account account = new Account("å°æ—å­", 15.0);
        double money[] = new double[] { 5.0, 300.0, 5000.0, 50000.0, 1000.0 };
        for (int x = 0; x < 2; x++) { // è®¾ç½®ä¸¤ä¸ªå†™çº¿ç¨‹
            new Thread(() -> {
                for (int y = 0; y < money.length; y++) {
                    account.saveMoney(money[y]);
                }
            }, "å­˜æ¬¾ç”¨æˆ·-" + x).start();
        }
        for (int x = 0; x < 10; x++) {
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName()
                        + "ã€æŸ¥è´¦ï¼Œè´¦æˆ·åï¼š" + account.getName() + "ã€èµ„äº§æ€»é¢ï¼š"
                        + account.loadMoney());
            },"æ”¶æ¬¾äºº-" + x).start();
        }
    }
}
class Account {
    private String name; // å¼€æˆ·å
    private double asset = 10.0; // é“¶è¡Œèµ„äº§
    // è¯»å†™åˆ†ç¦»
    private ReadWriteLock rwLock = new ReentrantReadWriteLock();
    public Account(String name, double asset) {
        this.name = name;
        this.asset = asset;
    }
    // è¿›è¡Œå­˜æ¬¾å¤„ç†
    public boolean saveMoney(double money) {
        this.rwLock.writeLock().lock(); // å¯¹å†™å…¥æ•°æ®è¿›è¡Œé”å®šå¤„ç†
        try {
            System.out.println("ã€ï¼ˆ"
                    + Thread.currentThread().getName()
                    + "ï¼‰å­˜æ¬¾-BEFOREã€‘å­˜æ¬¾é‡‘é¢ï¼š" + money);
            TimeUnit.SECONDS.sleep(1);
            if (money > 0.0) { // å¦‚æœè¦å­˜æ¬¾è‚¯å®šæ˜¯è¦æœ‰é’±
                this.asset += money;
                return true; // å­˜æ¬¾æˆåŠŸ
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("ã€ï¼ˆ"
                    + Thread.currentThread().getName()
                    + "ï¼‰å­˜æ¬¾-AFTERã€‘æ€»é‡‘é¢ï¼š" + this.asset);
            this.rwLock.writeLock().unlock(); // è¿›è¡Œè§£é”å¤„ç†
        }
        return false;
    }
    public String getName() {  return this.name; }
    public double loadMoney() { // è¿”å›å½“å‰çš„èµ„é‡‘
        try {
            this.rwLock.readLock().lock();
            return this.asset;
        } finally { this.rwLock.readLock().unlock();  }
    }
}
```
ç‹¬å é”å¤„ç†çš„é€Ÿåº¦æ…¢ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯çº¿ç¨‹æ•°æ®çš„å®‰å…¨æ€§ï¼Œè€Œå…±äº«é”å¤„ç†é€Ÿåº¦å¿«ï¼Œæ˜¯å¯¹å¤šä¸ªçº¿ç¨‹è¿›è¡Œçš„é”å¤„ç†æœºåˆ¶ï¼Œè€Œè¿™ä¸ªè¯»å†™çš„å¤„ç†å…³ç³»å¯æ˜¯é‡è¦çš„ç±»é›†ConcurrentHashMapçš„æ ¸å¿ƒå®ç°æ€æƒ³ã€‚
## ã€ é”çš„ç²¾ç¡®æ§åˆ¶ï¼šCondition ã€‘   

åœ¨ä¹‹å‰å·²æ¥è§¦è¿‡äº†ä¸€äº›åŸºç¡€çš„é”ï¼Œä½†åœ¨è¿›è¡Œå¤„ç†çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªæ¥å£Conditionï¼Œè¿™ä¸ªæ¥å£å¯ä»¥ç”±ç”¨æˆ·æ¥è‡ªå·±è¿›è¡Œé”çš„å¯¹è±¡åˆ›å»ºã€‚

- Conditionçš„ä½œç”¨æ˜¯å¯¹é”è¿›è¡Œæ›´ç²¾ç¡®çš„æ§åˆ¶ã€‚
  - Conditionä¸­çš„await()æ–¹æ³•ç›¸å½“äºObjectçš„wait()æ–¹æ³•ï¼Œ
  - Conditionä¸­çš„signal()æ–¹æ³•ç›¸å½“äºObjectçš„notify()æ–¹æ³•ï¼Œ
  - Conditionä¸­çš„signalAll()ç›¸å½“äºObjectçš„notifyAll()æ–¹æ³•ã€‚
  - ä¸åŒçš„æ˜¯ï¼ŒObjectä¸­çš„wait()ã€notify()ã€notifyAll()æ–¹æ³•æ˜¯å’Œâ€åŒæ­¥é”â€/â€œå…±äº«é”â€æ†ç»‘ä½¿ç”¨çš„ã€‚
  
èŒƒä¾‹ï¼šè§‚å¯ŸConditionçš„åŸºæœ¬ä½¿ç”¨
```java
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
public class MLDNTestDemo {
    public static String msg = null ;  // è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²
    public static void main(String[] args) throws Exception {
        // å®ä¾‹åŒ–Lockæ¥å£å¯¹è±¡
        Lock myLock = new ReentrantLock();
        // åˆ›å»ºä¸€ä¸ªæ–°çš„Conditionæ¥å£å¯¹è±¡
        Condition condition = myLock.newCondition();
        // å¦‚æœç°åœ¨ä¸è¿›è¡Œé”å®šï¼Œé‚£ä¹ˆConditionæ— æ³•æ‰§è¡Œç­‰å¾…å¤„ç†æœºåˆ¶ï¼Œä¼šå‡ºç°â€œIllegalMonitorStateExceptionâ€
        myLock.lock(); // ç°åœ¨æ˜¯åœ¨ä¸»çº¿ç¨‹ä¹‹ä¸­æ‰§è¡Œäº†ä¸€ä¸ªlock()å¤„ç†
        try {
            new Thread(()->{
                myLock.lock() ;
                try {
                    msg = "www.baidu.com" ;
                    condition.signal(); // å”¤é†’ç­‰å¾…çš„Condition
                } finally {
                    myLock.unlock();
                }
            }) .start();
            condition.await(); // çº¿ç¨‹ç­‰å¾…
            System.out.println("****ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œmsg = " +msg);
        } finally {
            myLock.unlock();   // è§£é™¤é˜»å¡çŠ¶æ€
        }
    }
}
```  

ä¸ä¹‹å‰Objectç›¸æ¯”ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼šç°åœ¨çœ‹ä¸è§æ˜ç¡®çš„synchronizedå…³é”®å­—ï¼Œè€Œå–ä»£synchronizedæ˜¯Lockæ¥å£ä¸­çš„lock()ã€unlock()ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œååœ¨é˜»å¡çŠ¶æ€ï¼ˆåŒæ­¥çŠ¶æ€ï¼‰ä¸‹å¯ä»¥ä½¿ç”¨Conditionæ¥å£ä¸­çš„await()ä¸signal()è¿›è¡Œç­‰å¾…ä¸å”¤é†’çš„æ“ä½œå¤„ç†ã€‚      æ¸…

æ¥šäº†ConditionåŸºæœ¬ä½¿ç”¨ä¹‹åï¼Œé‚£ä¹ˆä¸‹é¢å®ç°ä¸€ä¸ªç¨å¾®ç®€å•ä¸€ç‚¹æœ‰æ„æ€çš„ç¨‹åºï¼Œå¯¹äºæ•°ç»„æ“ä½œç±»å®é™…ä¸Šå®ƒè¿˜æœ‰ä¸€ä¸ªæ›´å¤§çš„ä½œç”¨ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®çš„ç¼“å†²æ“ä½œä½¿ç”¨ã€‚

èŒƒä¾‹ï¼šå®ç°æ•°æ®çš„ç¼“å†²æ§åˆ¶
```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
public class MLDNTestDemo {
    public static void main(String[] args) throws Exception {
        DataBuffer<String> buffer = new DataBuffer<String>() ;
        for (int x = 0 ; x < 3 ; x ++) {   // åˆ›å»ºä¸‰ä¸ªå†™çº¿ç¨‹
            new Thread(()->{
                for (int y = 0 ; y < 2 ; y ++) {
                    try {
                        TimeUnit.SECONDS.sleep(1);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    buffer.put(Thread.currentThread().getName() + "å†™å…¥æ•°æ®ï¼Œy = " + y);
                }
            },"ç”Ÿäº§è€…-" + x).start();
        }
        for (int x = 0 ; x < 5 ; x ++) {   // åˆ›å»ºäº”ä¸ªè¯»çº¿ç¨‹
            new Thread(()->{
                while(true) {
                    try {
                        TimeUnit.SECONDS.sleep(3);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    System.out.println("ã€ï¼ˆ"+Thread.currentThread().getName()+"ï¼‰CONSUMERã€‘" + buffer.get());
                }
            },"æ¶ˆè´¹è€…-" + x).start();
        }
    }
}
// è¿›è¡Œæ•°æ®çš„ç¼“å†²çš„æ“ä½œæ§åˆ¶ï¼Œè¯¥ç¼“å†²å¯ä»¥ä¿å­˜å„ç§æ•°æ®ç±»å‹
class DataBuffer<T> {
    // è¯¥ç±»ä¹‹ä¸­ä¿å­˜çš„æ•°ç»„çš„é•¿åº¦ä¸ªæ•°ä¸º5
    private static final int MAX_LENGTH = 5 ;
    // å®šä¹‰ä¸€ä¸ªæ•°ç»„è¿›è¡Œå…¨éƒ¨æ•°æ®çš„ä¿å­˜æ§åˆ¶
    private Object [] data = new Object [MAX_LENGTH] ;
    // åˆ›å»ºæ•°æ®é”
    private Lock myLock = new ReentrantLock();
    // æ•°æ®ä¿å­˜çš„Conditionæ§åˆ¶
    private Condition putCondition = myLock.newCondition() ;
    // æ•°æ®å–å¾—çš„Conditionæ§åˆ¶
    private Condition getCondition = myLock.newCondition() ;   
    private int putIndex = 0 ; // ä¿å­˜æ•°æ®çš„ç´¢å¼•
    private int getIndex = 0 ;     // è¯»å–æ•°æ®çš„ç´¢å¼•
    private int count = 0 ;    // å½“å‰ä¿å­˜çš„å…ƒç´ ä¸ªæ•°
    public T get() {   // æ ¹æ®ç¼“å†²è¯»å–æ•°æ®
        Object takeObject = null ;
        this.myLock.lock();
        try {
            if (this.count == 0) { // æ²¡æœ‰å†™å…¥
                // è¯»å–çš„çº¿ç¨‹è¦è¿›è¡Œç­‰å¾…
                this.getCondition.await(); 
            }
            // è¯»å–æŒ‡å®šç´¢å¼•æ•°æ®
            takeObject = this.data[this.getIndex ++] ; 
            if (this.getIndex == MAX_LENGTH) {
                this.getIndex = 0 ;    // é‡æ–°å¼€å§‹è¯»
            }
            // å› ä¸ºè¯»å–äº†ä¸€ä¸ªæ•°æ®ä¹‹åï¼Œç°åœ¨éœ€è¦å‡å°‘ä¸ªæ•°
            this.count -- ;
            // å‘Šè¯‰å†™çº¿ç¨‹å¯ä»¥å†™å…¥
            this.putCondition.signal(); 
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            this.myLock.unlock();
        }
        return (T) takeObject ;
    }
    // è¿›è¡Œç¼“å†²æ•°æ®çš„å†™å…¥å¤„ç†
    public void put(T t) {
        // è¿›å…¥ç‹¬å é”å®šçŠ¶æ€
        this.myLock.lock(); 
        try {
            // ä¿å­˜çš„æ•°æ®é‡å·²ç»æ»¡äº†
            if (this.count == MAX_LENGTH) {    
                // æš‚æ—¶å…ˆåˆ«è¿›è¡Œæ•°æ®ä¿å­˜äº†
                this.putCondition.await(); 
            }
            // ä¿å­˜å½“å‰çš„æ•°æ®
            this.data[this.putIndex ++] = t ;  
            // ç°åœ¨ç´¢å¼•å·²ç»å†™æ»¡
            if (this.putIndex == MAX_LENGTH) { 
                // é‡ç½®æ•°ç»„æ“ä½œçš„ç´¢å¼•è„šæ ‡
                this.putIndex = 0 ;    
            }
            // ä¿å­˜çš„ä¸ªæ•°éœ€è¦åšä¸€ä¸ªè¿½åŠ 
            this.count ++ ;    
            this.getCondition.signal(); // å”¤é†’æ¶ˆè´¹çº¿ç¨‹
            System.out.println("ã€ï¼ˆ" + Thread.currentThread().getName() + "ï¼‰å†™å…¥ç¼“å†²-put()ã€‘" + t);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // ä¸ç®¡å¦‚ä½•æœ€ç»ˆä¸€å®šè¦è¿›è¡Œè§£é”
            this.myLock.unlock(); 
        }
    }
}
```

å¯¹äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹çš„å®ç°ï¼Œé™¤äº†åœ¨è®²è§£å¤šçº¿ç¨‹åŸºç¡€å®ç°çš„æ¨¡å‹ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ä»¥ä¸Šçš„æ¨¡å‹åˆ©ç”¨Lockä¸Conditionè¿›è¡Œé”çš„ç²¾å‡†æ§åˆ¶ã€‚

## ã€ é˜»å¡åŸè¯­ï¼šLockSupport ã€‘
```java
java.util.concurrent.locks.LockSupport
```
è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼Œè¿™ä¸ªç±»çš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥è§£å†³Threadç±»é‡Œé¢æä¾›çš„suspend()ï¼ˆæŒ‚èµ·çº¿ç¨‹ï¼‰ã€resume()(å›å¤è¿è¡Œ)æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ¬è´¨ä¸Šä¼šå­˜åœ¨æœ‰æ­»é”çš„å«Œç–‘ï¼Œæ‰€ä»¥ä»JDK1.4å¼€å§‹å°†å…¶å°±å·²ç»åˆ—ä¸ºä¸å»ºè®®ä½¿ç”¨çš„æ–¹æ³•äº†ï¼Œä½†åœ¨JDKå¼€å‘JUCçš„æ¶æ„ä¹‹åï¼Œè€ƒè™‘åˆ°JUCæ¶æ„ä¹‹ä¸­çš„å„ç§å®ç°æœºåˆ¶ï¼Œäºæ˜¯å¼€å§‹è¯•å›¾è¿˜åŸä¹‹å‰è¢«åºŸå¼ƒçš„æ“ä½œï¼Œäºæ˜¯æœ‰äº†LockSupportç±»ï¼Œè¿™ä¸ªç±»é‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š
- æŒ‚èµ·ï¼špublic static void park(Object blocker);
- æ¢å¤ï¼špublic static void unpark(Thread thread);

èŒƒä¾‹ï¼šè§‚å¯ŸæŒ‚èµ·ä¸æ¢å¤æ‰§è¡Œ

```java
```
è¿™äº›å¤„ç†æ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯é’ˆå¯¹äºåŸå§‹çš„çº¿ç¨‹æ¨¡å‹çš„å®ç°æœºåˆ¶å®Œå–„ã€‚ä½¿ç”¨è¿™äº›ç±»çš„å¥½å¤„æ˜¯å¯ä»¥è½»æ¾ç®€å•çš„å®ç°çº¿ç¨‹åŒæ­¥é”ï¼Œå¹¶ä¸”å¯ä»¥é¿å…æ­»é”å¸¦æ¥çš„é—®é¢˜ã€‚ 
