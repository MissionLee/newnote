# è¾…åŠ©å·¥å…·ç±»

- Semaphore
  - åŸºäº AbstractQueuedSynchronizer å®ç°
  - ç›¸å½“äºå¯ä»¥å®šåˆ¶é”æ•°é‡çš„é”ï¼ˆä¾‹å¦‚ å¼€æ”¾ä¸¤ä¸ªæ¥å¾…å¤„æ¥å¾…æ•´ä¸ªé˜Ÿåˆ—è¿™ç§æœåŠ¡ï¼‰
  - æä¾›çš„æœåŠ¡ç±»ä¼¼äºlock
- CountDownLatch
  - è®¾ç½®stateåˆå§‹å€¼ä¸ºè‡ªå·±å¸Œæœ›çš„å€¼
  - åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œ -1 æ“ä½œ
  - ä¸»çº¿ç¨‹é”å®šï¼šåˆ¤æ–­æ˜¯å¦stateä¸º0
    - å½“æ‰€æœ‰ï¼ˆè‡ªå·±è®¾å®šçš„æ•°é‡ï¼‰å­çº¿ç¨‹éƒ½æ‰§è¡Œäº† -1
    - ä¸»çº¿ç¨‹ awaitå®Œç»“ç»§ç»­åç»­ä»£ç 
- CyclicBarrier ï¼ˆä¸CountDownLatchç›¸ä¼¼ï¼‰
  - æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€åï¼Œå¯ä»¥åŒæ—¶è·å¾—è®¸å¯ç»§ç»­å·¥ä½œä¸‹å»
- Exchanger ğŸ”º ExchangeråŸç†æ²¡æœ‰åˆ†æ
  - ç”¨äºä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®
  - å¤šä½™ä¸¤ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ç”¨äº ç”Ÿäº§è€…/æ¶ˆè´¹è€… è¿™ç§ä¸šåŠ¡æ¨¡å‹ä¸‹ï¼Œè¶…è¿‡ä¸¤ä¸ªçº¿ç¨‹ å°±æ²¡æ³•å®šä½ ç”Ÿäº§/æ¶ˆè´¹çš„èº«ä»½äº†
- CompletableFuture 1.8æ·»åŠ æ–°å†…å®¹ 
  - æä¾›æ–°çš„æ–¹å¼å®Œæˆå¼‚æ­¥å¤„ç†ï¼ŒåŒ…æ‹¬åˆæˆå’Œç»„åˆæ—¶é—´çš„éé˜»å¡æ–¹å¼
  - çº¿ç¨‹ä¼šåœ¨ .get()æ–¹æ³•æš‚åœï¼ŒçŸ¥é“ .get() è¿”å›
  - é€šè¿‡ .complete å¯ä»¥ç»™å®šâ€œå‘½ä»¤å€¼â€ï¼Œæ­¤æ—¶ .get()å¯ä»¥è·å¾—å¯¹åº”å€¼ï¼Œæ‰€æœ‰â€œé”ä½â€çš„çº¿ç¨‹éƒ½èƒ½å¤Ÿç»§ç»­æ‰§è¡Œ
## ä¿¡å·é‡ Semaphore

ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚

æ¶µä¹‰ä¸Šï¼šä¿¡å·é‡æŒæœ‰ä¸€ç»„è®¸å¯ï¼Œåœ¨æ²¡æœ‰è·å¾—è®¸å¯çš„æ—¶å€™ï¼Œacquireä¼šè¢«é˜»å¡ã€‚æ¯æ¬¡releaseéƒ½ä¼šäº¤è¿˜permitï¼ŒåŒæ—¶ä¼šè®©ä¸€ä¸ªè¢«é˜»å¡çš„ç”³è¯·è€…é€šè¿‡ã€‚

åœ¨å®ç°æ–¹å¼ä¸Šï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ â€œpermit objectâ€ï¼Œä¿¡å·é‡ä»…ä»…ç»´æŠ¤å¯ç”¨æ•°é‡å¹¶ä¸€æ¬¡å†³å®šå…¶è¡Œä¸º

åœ¨åº•å±‚ï¼ˆå†…éƒ¨ï¼‰ï¼ŒSemaphore å®ç°äº†ä¸€ä¸ª AbstractQueuedSynchronizerï¼Œå¹¶ä¸”é€šè¿‡å®ç°å…¶ä¸­
- tryReleaseShared
- nonfairTryAcquireShared
- tryAcquireShared
å‡ ä¸ªæ–¹æ³•ï¼Œå®Œæˆç›¸å…³çš„æ“ä½œ

- ä¸»è¦é€»è¾‘ï¼š
  - å°†å…è®¸çš„å¹¶å‘æ•°ä¼ é€’ç»™ Semaphoreçš„æ„é€ ï¼ŒSemaphoreä¼šå°†å…¶ä½œä¸ºåˆå§‹å€¼èµ‹å€¼ç»™ å†…éƒ¨å®ç°çš„ AbstractQueuedSynchronizerçš„ stateå­—æ®µ
  - æ¯æ¬¡acquireçš„æ—¶å€™ï¼ˆtryAcquireSharedï¼‰ï¼Œå°±ä¼šåˆ¤æ–­å½“å‰
```java
/**
 * Acquires in shared interruptible mode.
 * @param arg the acquire argument
 */
private void doAcquireSharedInterruptibly(int arg)
    throws InterruptedException {
    final Node node = addWaiter(Node.SHARED);
    boolean failed = true;
    try {
        for (;;) {
            final Node p = node.predecessor();
            if (p == head) {
                int r = tryAcquireShared(arg);
                if (r >= 0) {
                    setHeadAndPropagate(node, r);
                    p.next = null; // help GC
                    failed = false;
                    return;
                }
            }
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                throw new InterruptedException();
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
// Semaphoreä¸­å®ç°çš„tryAcquireShared
protected int tryAcquireShared(int acquires) {
    for (;;) {  // æ³¨æ„ è¿™é‡Œå¹¶ä¸æ˜¯ è‡ªæ—‹ä½ç½®ï¼Œè¿™ä¸ª æ— é™å¾ªç¯å¾ˆå®¹ä»¥ returné™¤å» å¦‚æœæ¯”è¾ƒç¹å¿™ å¤šæ•°æƒ…å†µ remaining<0 æ­¤æ—¶ä¼šå›åˆ°ä¸Šä¸€å±‚çš„å¾ªç¯
                // å¦‚æœä¸ç¹å¿™ casæ“ä½œå¾ˆå®¹ä»¥é€šè¿‡
        if (hasQueuedPredecessors())
            return -1;
        int available = getState(); // è·å–å½“å‰state
        int remaining = available - acquires; // è®¡ç®—æ›´æ”¹åçš„state 
        if (remaining < 0 ||
            compareAndSetState(available, remaining))
            return remaining;
    }
}
```
## CountDownLatch

ç”¨äºä¿è¯æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ååœ¨è¿›è¡Œç¨‹åºçš„è¾“å‡ºè®¡ç®—

```java
public class LearnCountDownLatch {
    public static void main(String[] args) throws InterruptedException {
        CountDownLatch cdl = new CountDownLatch(5);
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName());
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                cdl.countDown();
            }).start();
        }
        System.out.println("===");
        cdl.await();
        Thread.sleep(100);
        System.out.println("å…¨éƒ¨ç»“æŸ");
    }
}
```
è¾“å‡ºç»“æœ
```bash
## ä¸€ç§è¿è¡Œç»“æœ
Thread-0
Thread-2
Thread-1
===
Thread-3
Thread-4
å…¨éƒ¨ç»“æŸ
## ä¸€ç§è¿è¡Œç»“æœ
===
Thread-2
Thread-0
Thread-1
Thread-4
Thread-3
å…¨éƒ¨ç»“æŸ
```

åŸç†æ˜¯ æ¯ä¸ªçº¿ç¨‹ è¿›è¡Œ -1 æ“ä½œï¼Œawait åˆ¤æ–­æ­¤æ—¶ä¸º 0. åŒæ ·æ˜¯ç”¨çš„AbstractQueuedSynchronizerå®ç°


## CompletableFuture

è®©å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€å¤„ï¼ˆgetï¼‰ç­‰å¾…ï¼Œä¸€æ—¦è°ƒç”¨ complete æ–¹æ³•ï¼Œæ‰€æœ‰åœ¨getä½ç½®çš„çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œ

ä½¿ç”¨ï¼šæ¯ä¸ªçº¿ç¨‹å¯ä»¥å¯¹çš„åˆ°çš„ â€œæ•°æ®â€ è¿›è¡Œåˆ¤æ–­æ“ä½œè®¡ç®—ç­‰ï¼Œä»¥æ­¤æ¥å†³å®šè‡ªå·±æ¥ä¸‹æ¥çš„èµ°å‘
```java
public class LearnCompletableFuture {
    public static void main(String[] args) throws InterruptedException {
        CompletableFuture<String> future = new CompletableFuture<>();
        for (int i = 0; i < 10; i++) {
            new Thread(()->{
                System.out.println(Thread.currentThread().getName()+"\t å°±ä½");
                try {
                    String cmd = future.get();
                    System.out.println(Thread.currentThread().getName()+"\t è·å¾—å†…å®¹ï¼š"+cmd);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } catch (ExecutionException e) {
                    e.printStackTrace();
                }
            },"ç­‰å¾…è€…"+i).start();
        }
        TimeUnit.SECONDS.sleep(5);
        future.complete("ä¹…ç­‰äº†ï¼Œä¸€èµ·happy");
    }
}
```